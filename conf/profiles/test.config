/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Nextflow config file for running minimal tests
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Defines input files and everything required to run a fast and simple pipeline test.

    Use as follows:
        nextflow run nf-core/oncoseq -profile test,<docker/singularity> --outdir <OUTDIR>

----------------------------------------------------------------------------------------
*/
// -----------------------------
// Process resource limits for test
// -----------------------------
process {
    errorStrategy = { task.attempt < 2 ? 'retry' : 'ignore' }
    maxRetries = 1
    cpus = 2
    resourceLimits = [
        cpus: 2,           // Max CPUs per process (test)
        memory: '6.GB',   // Max memory per process (test)
        time: '1.h'        // Max time per process (test)
    ]
}

// -----------------------------
// Pipeline parameter overrides for test
// -----------------------------
params {
    config_profile_name        = 'Test profile' // Profile name for reporting
    config_profile_description = 'Minimal test dataset to check pipeline function' // Description
    outdir = 'test_out'                        // Output directory for test run
    // Input data
    input  = params.pipelines_testdata_base_path + 'basecalling/samplesheets/samplesheet.csv' // Test samplesheet
    clairsto_model             = 'ont_r10_dorado_sup_5khz_ssrs'
    basecall_model       = 'ont_r10_dorado_sup_5khz_ssrs' // ClairS_TO model
    device = null                             // No specific device for test
    // TODO mpgi: make a better dataset for demultiplexing, possibly cfnda
    //demux = 'SQK-NBD114-24'                  // Uncomment to test demultiplexing
    //demux_samplesheet = params.pipelines_testdata_base_path + 'samplesheets/demux_samplesheet.csv'
    //ubam_samplesheet = params.pipelines_testdata_base_path + 'samplesheets/ubam_samplesheet.csv'
    publish_dir_mode = 'copy'                  // Copy outputs for test
    minqs = 8                                  // Lower quality threshold for test
    bed = params.pipelines_testdata_base_path + 'adaptive/2025-02-05-CHUSJ-Panel-20kb-LP.bed' // Test BED file
    max_cpus = 2                               // Limit CPUs for test
    max_memory = '6.GB'                       // Limit memory for test
    max_time = '1.h'                           // Limit time for test
    clin_database = "${projectDir}/refs/clinvar.vcf.{gz,gz.tbi}"                   // Use ClinVar for test
}

// -----------------------------
// Apptainer (Singularity) container options for test
// -----------------------------
apptainer {
    enabled=true                              // Enable Apptainer for test
    autoMounts=true                           // Automatically mount common host paths
    runOptions = '--writable-tmpfs'           // Use writable tmpfs for container
    cacheDir = "/tmp/apptainer/cache"         // Use /tmp for image cache in test
}

// Per-process overrides for test profile
process {
    withName: 'MINIMAP2_ALIGN' {
        cpus = 2
        memory = '6.GB'
    }
}

// Also lower resources for processes that use the `process_high` label
process {
    withLabel: 'process_high' {
        cpus = 2
        memory = '6.GB'
    }
}